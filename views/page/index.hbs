<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="static/modal-add.hbs">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <title>Document</title>
</head>
<body>
  <div class="container mt-5 "> 
    <div class="add mx-5 mb-5 ">   
{{> modalClientAdd}}

{{> filterClient}}

{{> card}}

{{> modalEditClient}}

{{> pagination}}
  </div>
 <script>
   //ADD-CLIENT
document.getElementById('submit').addEventListener('click', function (e) {
  e.preventDefault();
  addClient();
});
document.getElementById('limit').addEventListener('change', function (e) {
  e.preventDefault();
  paginButtons();
});
 document.getElementById('filter').addEventListener('click', function (e) {
  e.preventDefault();
  filtering()
});
window.onload = function () {
  
};






  function getCargs(items) {
    console.log('sxdctfvygbuhnijmk,cfvghbjnkmk,'+ items)
  let cards = '';
  for (let i = 0; i < items.length; i++) {
    cards +=
      ` <div class='card border-primary mb-2'>
      <div class='row'>
        <div class='col-md-3 text'>

          <img
            src='http://localhost:3000/profileimagies/`+ items[i].avatar +
      `'
            style='width: 150px; height: 150px; object-fit: cover;'
            class='rounded'
          />
        </div>
            
            <div class='col-md-3 mt-3'>
          <div class='text-default text mt-3'>` +
      items[i].name +
      ` ` +
      items[i].lastName +
      `
          </div>
          <div class='text-default text mt-2'>` +
      items[i].date +
      `</div>
        </div>
         <div class='col-md-3 mt-3'>
          <div class='text-default text mt-3'>` +
      items[i].email +
      `</div>
          <div class='text-default text mt-2'>+380` +
      items[i].tel +
      `</div>
        </div>
<div class='col-md-3 mt-3'>
          <button
            class='edit_button btn btn-outline-primary text mt-2'
            data-bs-toggle='modal'
            data-bs-target='#editModal'
            style='width: 130px;'
            id={{id}}
          > edit client </button>
          <br /><br />
          <!-- кнопка delete -->
          <button
            class='delete_button btn btn-outline-danger text'
            id='` +
      items[i].id +
      `" onclick="delete1(` +
      items[i].id +
      `)">'
            style='width: 130px;'
          >
            delete client
          </button>
        </div>
      </div>
    </div>`
  }
  let l = document.getElementById('result');
  l.innerHTML = cards;
}




//SCRIPT PAGINATE


function paginButtons(length) {
  let limit = getLimit();
  let button = '';
    for (let i = 1; i <= length; i++) {
      button +=
        `<li class="page-item col-md-1"><a class="page-link" id="` +
        i +
        `"  onclick = getPagin(` +
        i +
        `) href="#">` +
        i +
        `</a></li>`;
    }
    let l = document.getElementById('pagin');
    l.innerHTML = button;
}

function getLimit() {
  let limit = document.getElementById('limit');
  return limit.value;
}

function getPagin(i) {
  let client = JSON.stringify({ id: i });
  let request = new XMLHttpRequest();
  let test = `?page=` + i + `&limit=` + getLimit() + `&sortBy=id:ASC&`;
  sendPagin(test);
  request.open('GET', '/', true);
  request.setRequestHeader('Content-Type', 'application/json');
  request.send(client);
  request.onload = function () {
    console.log(request.response);
    let res = $.parseJSON(request.response);
    let cards = '';
    getCargs(res.result.data);
    getCountOfButtons(res.result)
  };
}





 function filtering() {
  let registerForm = document.forms['filterClient'];
  let name = registerForm.elements['name'].value;
  let lastName = registerForm.elements['lastName'].value;
  let tel = registerForm.elements['tel'].value;
  let email = registerForm.elements['email'].value;
  let date = registerForm.elements['date'].value;
  console.log(date);
  let path = `?name=` + name + `&`+`lastName=` + lastName + `&`+`email=` + email + `&`+`tel=` + tel + `&`+`date=` + date + `&`+ `page=` + 0 + `&limit=` + getLimit();
  console.log(path)
  let request = new XMLHttpRequest();
  request.open('GET', '/paginate' + path, true);
  request.setRequestHeader('Content-Type', 'application/json');
  request.send(path);
  request.onload = function(){
    //document.open();
    //document.write(request.response);
    //document.close();
    console.log(request.response.clientsPageable)
    let res = JSON.parse(request.response)
    console.log(res.clientsPageable)
    getCargs(res.clientsPageable.items);
    console.log(res.clientsPageable.meta.totalPages)
    paginButtons(res.clientsPageable.meta.totalPages)
  }
}


// SCRIPT DELETE
var del = document.getElementsByClassName('delete_button');
for (var i = 0; i < del.length; i++)
  del[i].onclick = function () {
    alert('Do you want to delete this client?');
    let client = JSON.stringify({ id: this.id });
    let request = new XMLHttpRequest();
    request.open('DELETE', '/delete' + this.id, true);
    request.setRequestHeader('Content-Type', 'application/json');
    request.send(client);
    request.onload = function () {
      console.log(request.response);
      filtering();
    };
  };
  
function delete1(id1) {
  alert('Do you want to delete this client?');
  let client = JSON.stringify({ id: id1 });
  let request = new XMLHttpRequest();
  request.open('DELETE', '/delete' + id1, true);
  request.setRequestHeader('Content-Type', 'application/json');
  request.send(client);
  request.onload = function () {
    console.log(request.response);
  };
}

//SCRIPT GET FOR EDIT
var get = document.getElementsByClassName('edit_button');
for (var i = 0; i < get.length; i++)
  get[i].onclick = function () {
    let client = JSON.stringify({ id: this.id });
    let request = new XMLHttpRequest();
  };
 //////////////////////////////////////////////////////////////////////////////



function addClient(){
  let registerForm = document.forms['addClient'];
  let name = registerForm.elements['name'].value;
  let lastName = registerForm.elements['lastName'].value;
  let tel = registerForm.elements['tel'].value;
  let email = registerForm.elements['email'].value;
  let date = registerForm.elements['date'].value;
  var input = document.getElementById('img');
  let data = new FormData();
  data.append('name', name);
  data.append('lastName', lastName);
  data.append('tel', tel);
  data.append('email', email);
  data.append('date', date);
  data.append('avatar', input.files[0]);
  let data_body =
    '&name=' +
    name +
    '&lastName=' +
    lastName +
    '&tel=' +
    tel +
    '&email=' +
    email +
    '&date=' +
    date;
    console.log('data '+ data)
  fetch('clientAdd', {
    method: 'POST',
    body: data,
    contentType: 'multipart/form-data',
    headers: { 'content-type': 'application/x-www-form-urlencoded' },
  })
    .then((response) => {
      if (response.status !== 200) {
        return Promise.reject();
      }
      return response.text();
    })
    .then((i) => console.log(i))
    .catch(() => filtering());
  var inputs = document.querySelectorAll('input');
  for (var i = 0; i < inputs.length; i++) {
    inputs[i].value = '';
  }
}

</script>
<script src="//code.jquery.com/jquery-1.12.0.min.js"></script>
<script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<script src = "../nest-categ/todo-categ/src/client/client.controller.ts"></script>

<!-- jQuery -->

<!-- Latest compiled and minified JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
</body>
</html>